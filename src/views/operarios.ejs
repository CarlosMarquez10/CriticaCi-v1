<%- include('partials/header', { title: 'Consulta de Operarios' }) %>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Inicio</a></li>
          <li class="breadcrumb-item active">Consulta de Operarios</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-user-hard-hat me-2"></i>
            Consulta de Operarios
          </h4>
        </div>
        <div class="card-body">
          <form id="formConsulta" class="row g-3">
            <div class="col-md-6">
              <label for="cedula" class="form-label">Cédula del Operario</label>
              <input
                type="text"
                class="form-control"
                id="cedula"
                name="cedula"
                value="<%= cedula %>"
                placeholder="Ingrese la cédula del operario"
              />
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-search me-2"></i>Consultar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <% if (cedula) { %>
  <div class="row mb-4">
    <!-- Información del Operario - Lado Izquierdo -->
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Información del Operario</h5>
        </div>
        <div class="card-body text-center">
          <% if (fotoUrl) { %>
          <img
            src="<%= fotoUrl %>"
            alt="Foto del operario"
            class="img-fluid rounded mb-3"
            style="max-height: 200px"
          />
          <% } else { %>
          <div
            class="bg-light p-5 rounded mb-3 d-flex align-items-center justify-content-center"
          >
            <i class="fas fa-user fa-4x text-secondary"></i>
          </div>
          <% } %>
          <h4><%= cedula %></h4>
          <% if (registros.length > 0) { %>
          <p class="mb-1">
            <strong>Nombre:</strong> <%= registros[0].Operario || 'No disponible' %>
          </p>
          <p class="mb-1">
            <strong>Cargo:</strong> <%= registros[0].tipo || 'No disponible' %>
          </p>
          <p class="mb-0">
            <strong>Sede:</strong> <%= registros[0].sede || 'No disponible' %>
          </p>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Estadísticas y Estado de Errores - Lado Derecho -->
    <div class="col-md-6">
      <!-- Estadísticas -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Estadísticas</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 text-center mb-3">
              <div class="bg-light p-3 rounded">
                <h3><%= registros.length %></h3>
                <p class="mb-0">Total Registros</p>
              </div>
            </div>
            <div class="col-md-4 text-center mb-3">
              <div class="bg-light p-3 rounded">
                <h3>
                  <% var errores = 0; if (registros.length > 0) { registros.forEach(function(reg) { if (reg.TIPODEERROR && reg.TIPODEERROR !== 'Sin error') errores++; }); } %>
                  <%= errores %>
                </h3>
                <p class="mb-0">Con Errores</p>
              </div>
            </div>
            <div class="col-md-4 text-center mb-3">
              <div class="bg-light p-3 rounded">
                <h3>
                  <% var porcentaje = 0; if (registros.length > 0) {
                  porcentaje = ((registros.length - errores) /
                  registros.length * 100).toFixed(1); } %> <%= porcentaje %>%
                </h3>
                <p class="mb-0">Efectividad</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estado de Errores -->
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Estado de Errores</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 text-center mb-3">
              <div class="bg-light p-3 rounded">
                <h3>
                  <% if (typeof validacionStats !== 'undefined') { %>
                    <%= validacionStats.SI %>
                  <% } else { %>
                    0
                  <% } %>
                </h3>
                <p class="mb-0">Validados</p>
              </div>
            </div>
            <div class="col-md-4 text-center mb-3">
              <div class="bg-light p-3 rounded">
                <h3>
                  <% if (typeof validacionStats !== 'undefined') { %>
                    <%= validacionStats.NO %>
                  <% } else { %>
                    0
                  <% } %>
                </h3>
                <p class="mb-0">No Validados</p>
              </div>
            </div>
            <div class="col-md-4 text-center mb-3">
              <div class="bg-light p-3 rounded">
                <h3>
                  <% if (typeof validacionStats !== 'undefined') { %>
                    <%= validacionStats.Pendiente %>
                  <% } else { %>
                    0
                  <% } %>
                </h3>
                <p class="mb-0">Pendientes</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    </div>

  <!-- Tabla de Registros - Contenedor Separado -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Registros del Operario
          </h5>
          <button id="exportarExcel" class="btn btn-sm btn-light">
            <i class="fas fa-file-excel me-2"></i>Exportar a Excel
          </button>
        </div>
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          <% if (error) { %>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i><%= error %>
          </div>
          <% } else { %>
          <div class="table-responsive">
            <table id="tablaRegistros" class="table table-striped table-hover table-sm">
              <thead class="table-dark">
                <tr>
                  <th>USUARIO</th>
                  <th>ZONA/CICLO</th>
                  <th>FECHALECTURA</th>
                  <th>LECTURATOMADA</th>
                  <th>LECTURAFACTURADA</th>
                  <th>KWAJUSTADOS</th>
                  <th>TIPODEERROR</th>
                  <th>TIPOMEDIDOR</th>
                  <th>INTENTOS</th>
                  <th>VALIDACION</th>
                </tr>
              </thead>
              <tbody>
                <% registros.forEach(function(reg) { %>
                <tr>
                  <td><%= reg.USUARIO || '-' %></td>
                  <td><%= reg.ZONA || '-' %></td>
                  <td><%= reg.FECHALECTURA || '-' %></td>
                  <td><%= reg.LECTURATOMADA || '-' %></td>
                  <td><%= reg.LECTURAFACTURADA || '-' %></td>
                  <td class="text-center">
                    <span class="badge <%= reg.KWAJUSTADOS > 0 ? 'bg-success' : reg.KWAJUSTADOS < 0 ? 'bg-danger' : 'bg-secondary' %>">
                      <%= reg.KWAJUSTADOS || '-' %>
                    </span>
                  </td>
                  <td>
                    <span class="badge <%= reg.TIPODEERROR === 'ANALISIS' ? 'bg-warning text-dark' : reg.TIPODEERROR === 'RECLAMOS' ? 'bg-info' : reg.TIPODEERROR === 'AJUSTES' ? 'bg-danger' : 'bg-success' %>">
                      <%= reg.TIPODEERROR || 'Sin Error' %>
                    </span>
                  </td>
                  <td><%= reg.tipomedidor || '-' %></td>
                  <td class="text-center"><%= reg.Intentos || '-' %></td>
                  <td>
                    <span class="badge <%= reg.Validacion === 'SI' ? 'bg-success' : reg.Validacion === 'NO' ? 'bg-danger' : 'bg-warning text-dark' %>">
                      <%= reg.Validacion || 'PENDIENTE' %>
                    </span>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficas - 2 por fila -->
  <div class="row mb-4">
    <div class="col-12">
      <!-- Primera fila con 2 gráficas -->
      <div class="row mb-4">
        <div class="col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header bg-info text-white py-2">
              <h6 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>KW Ajustados
              </h6>
            </div>
            <div class="card-body p-3 d-flex align-items-center justify-content-center" style="height: 300px;">
              <canvas id="chartKWAjustados" style="max-height: 250px; width: 100%;"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header bg-warning text-dark py-2">
              <h6 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Tipos de Errores
              </h6>
            </div>
            <div class="card-body p-3 d-flex align-items-center justify-content-center" style="height: 300px;">
              <canvas id="chartTiposErrores" style="max-height: 250px; width: 100%;"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Segunda fila con 2 gráficas -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header bg-success text-white py-2">
              <h6 class="mb-0">
                <i class="fas fa-chart-doughnut me-2"></i>Tipos de Medidores
              </h6>
            </div>
            <div class="card-body p-3 d-flex align-items-center justify-content-center" style="height: 300px;">
              <canvas id="chartTiposMedidores" style="max-height: 250px; width: 100%;"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header bg-purple text-white py-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;">
              <h6 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>Top 10 Marcas de Medidores
                <span id="marcasMedidoresCount" class="badge bg-light text-dark ms-2">0 marcas</span>
              </h6>
            </div>
            <div class="card-body p-3">
              <!-- Estadísticas de marcas -->
              <div class="row mb-3">
                <div class="col-4 text-center">
                  <div class="bg-light p-2 rounded">
                    <small class="text-muted d-block">Total Medidores</small>
                    <strong id="totalMedidoresOperario">0</strong>
                  </div>
                </div>
                <div class="col-4 text-center">
                  <div class="bg-light p-2 rounded">
                    <small class="text-muted d-block">Total Marcas</small>
                    <strong id="totalMarcasOperario">0</strong>
                  </div>
                </div>
                <div class="col-4 text-center">
                  <div class="bg-light p-2 rounded">
                    <small class="text-muted d-block">Marca Principal</small>
                    <strong id="marcaPrincipalOperario">-</strong>
                  </div>
                </div>
              </div>
              <!-- Canvas para la gráfica -->
              <div style="height: 200px;">
                <canvas id="marcasMedidoresOperarioChart" style="max-height: 200px; width: 100%;"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% } %>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Inicializar DataTable
    if (document.getElementById("tablaRegistros")) {
      new DataTable("#tablaRegistros", {
        language: {
          url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json",
        },
      });
    }

    // Manejar envío del formulario
    document
      .getElementById("formConsulta")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const cedula = document.getElementById("cedula").value.trim();
        if (cedula) {
          window.location.href = `/operarios?cedula=${cedula}`;
        }
      });
  });
</script>

<% if (registros.length > 0) { %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Gráfico de KW Ajustados
      var kwRangos = {
          'Positivos altos (>1000)': 0,
          'Positivos medios (100-1000)': 0,
          'Positivos bajos (0-100)': 0,
          'Sin ajuste (0)': 0,
          'Negativos bajos (0 a -100)': 0,
          'Negativos medios (-100 a -1000)': 0,
          'Negativos altos (< -1000)': 0
      };

      <% registros.forEach(function(reg) { %>
          var kw = parseFloat(<%= reg.KWAJUSTADOS || 0 %>);
          if (kw > 1000) kwRangos['Positivos altos (>1000)']++;
          else if (kw > 100) kwRangos['Positivos medios (100-1000)']++;
          else if (kw > 0) kwRangos['Positivos bajos (0-100)']++;
          else if (kw === 0) kwRangos['Sin ajuste (0)']++;
          else if (kw > -100) kwRangos['Negativos bajos (0 a -100)']++;
          else if (kw > -1000) kwRangos['Negativos medios (-100 a -1000)']++;
          else kwRangos['Negativos altos (< -1000)']++;
      <% }); %>

      var ctx = document.getElementById('chartKWAjustados').getContext('2d');
      new Chart(ctx, {
          type: 'bar',
          data: {
              labels: Object.keys(kwRangos),
              datasets: [{
                  label: 'Cantidad de registros',
                  data: Object.values(kwRangos),
                  backgroundColor: [
                      'rgba(255, 99, 132, 0.5)',
                      'rgba(255, 159, 64, 0.5)',
                      'rgba(255, 205, 86, 0.5)',
                      'rgba(75, 192, 192, 0.5)',
                      'rgba(54, 162, 235, 0.5)',
                      'rgba(153, 102, 255, 0.5)',
                      'rgba(201, 203, 207, 0.5)'
                  ],
                  borderColor: [
                      'rgb(255, 99, 132)',
                      'rgb(255, 159, 64)',
                      'rgb(255, 205, 86)',
                      'rgb(75, 192, 192)',
                      'rgb(54, 162, 235)',
                      'rgb(153, 102, 255)',
                      'rgb(201, 203, 207)'
                  ],
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: {
                      position: 'top',
                  },
                  title: {
                      display: true,
                      text: 'Distribución de KW Ajustados'
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          precision: 0
                      }
                  }
              }
          }
      });

      // Gráfico de Tipos de Errores
      var tiposErrores = {};

      <% registros.forEach(function(reg) { %>
          var tipoError = "<%= reg.TIPODEERROR || 'No especificado' %>";
          tiposErrores[tipoError] = (tiposErrores[tipoError] || 0) + 1;
      <% }); %>

      var ctxErrores = document.getElementById('chartTiposErrores').getContext('2d');
      new Chart(ctxErrores, {
          type: 'pie',
          data: {
              labels: Object.keys(tiposErrores),
              datasets: [{
                  data: Object.values(tiposErrores),
                  backgroundColor: [
                      'rgba(255, 99, 132, 0.5)',
                      'rgba(255, 159, 64, 0.5)',
                      'rgba(255, 205, 86, 0.5)',
                      'rgba(75, 192, 192, 0.5)',
                      'rgba(54, 162, 235, 0.5)',
                      'rgba(153, 102, 255, 0.5)',
                      'rgba(201, 203, 207, 0.5)'
                  ],
                  borderColor: function(context) {
                      var index = context.dataIndex;
                      var colors = [
                          'rgb(255, 99, 132)',
                          'rgb(255, 159, 64)',
                          'rgb(255, 205, 86)',
                          'rgb(75, 192, 192)',
                          'rgb(54, 162, 235)',
                          'rgb(153, 102, 255)',
                          'rgb(201, 203, 207)'
                      ];
                      return colors[index % colors.length];
                  },
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: {
                      position: 'top',
                  },
                  title: {
                      display: true,
                      text: 'Distribución de Tipos de Errores'
                  }
              }
          }
      });

      // Gráfico de Tipos de Medidores
      var tiposMedidores = {};

      <% registros.forEach(function(reg) { %>
          var tipoMedidor = "<%= reg.tipomedidor || 'No especificado' %>";
          tiposMedidores[tipoMedidor] = (tiposMedidores[tipoMedidor] || 0) + 1;
      <% }); %>

      var ctxMedidores = document.getElementById('chartTiposMedidores').getContext('2d');
      new Chart(ctxMedidores, {
          type: 'doughnut',
          data: {
              labels: Object.keys(tiposMedidores),
              datasets: [{
                  data: Object.values(tiposMedidores),
                  backgroundColor: [
                      'rgba(255, 99, 132, 0.5)',
                      'rgba(255, 159, 64, 0.5)',
                      'rgba(255, 205, 86, 0.5)',
                      'rgba(75, 192, 192, 0.5)',
                      'rgba(54, 162, 235, 0.5)',
                      'rgba(153, 102, 255, 0.5)',
                      'rgba(201, 203, 207, 0.5)'
                  ],
                  borderColor: function(context) {
                      var index = context.dataIndex;
                      var colors = [
                          'rgb(255, 99, 132)',
                          'rgb(255, 159, 64)',
                          'rgb(255, 205, 86)',
                          'rgb(75, 192, 192)',
                          'rgb(54, 162, 235)',
                          'rgb(153, 102, 255)',
                          'rgb(201, 203, 207)'
                      ];
                      return colors[index % colors.length];
                  },
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              plugins: {
                  legend: {
                      position: 'top',
                  },
                  title: {
                      display: true,
                      text: 'Distribución de Tipos de Medidores'
                  }
              }
          }
      });

      // Gráfico de Marcas de Medidores del Operario
      const cedula = '<%= cedula %>';
      if (cedula) {
          fetch(`<%= baseUrl %>/operarios/marcas-medidores/${cedula}`)
              .then(response => response.json())
              .then(data => {
                  // Actualizar estadísticas
                  document.getElementById('totalMedidoresOperario').textContent = data.total;
                  document.getElementById('totalMarcasOperario').textContent = data.totalMarcas;
                  document.getElementById('marcaPrincipalOperario').textContent = data.marcas[0]?.marca || '-';
                  document.getElementById('marcasMedidoresCount').textContent = `${data.marcas.length} marcas`;

                  // Crear gráfica de barras horizontales
                  const marcasCtx = document.getElementById('marcasMedidoresOperarioChart').getContext('2d');
                  new Chart(marcasCtx, {
                      type: 'bar',
                      data: {
                          labels: data.marcas.map(m => m.marca),
                          datasets: [{
                              label: 'Cantidad de Medidores',
                              data: data.marcas.map(m => m.count),
                              backgroundColor: [
                                  '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                                  '#43e97b', '#fa709a', '#fee140', '#a8edea', '#d299c2'
                              ],
                              borderColor: [
                                  '#5a67d8', '#6b46c1', '#e879f9', '#ef4444', '#3b82f6',
                                  '#10b981', '#ec4899', '#f59e0b', '#06b6d4', '#a855f7'
                              ],
                              borderWidth: 2
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          indexAxis: 'y', // Barras horizontales
                          scales: {
                              x: {
                                  beginAtZero: true,
                                  grid: {
                                      display: true
                                  }
                              },
                              y: {
                                  grid: {
                                      display: false
                                  }
                              }
                          },
                          plugins: {
                              legend: {
                                  display: false
                              },
                              tooltip: {
                                  callbacks: {
                                      label: function(context) {
                                          const marca = context.label;
                                          const count = context.raw;
                                          const percentage = data.marcas.find(m => m.marca === marca)?.percentage || '0';
                                          return `${marca}: ${count} medidores (${percentage}%)`;
                                      }
                                  }
                              }
                          }
                      }
                  });
              })
              .catch(error => {
                  console.error('Error al cargar marcas de medidores del operario:', error);
                  document.getElementById('marcasMedidoresCount').textContent = 'Error al cargar';
              });
      }

      // Exportar a Excel
      document.getElementById('exportarExcel').addEventListener('click', function() {
          var data = [];
          var headers = [];

          // Obtener encabezados
          var tableHeaders = document.querySelectorAll('#tablaRegistros thead th');
          tableHeaders.forEach(function(th) {
              headers.push(th.textContent);
          });
          data.push(headers);

          // Obtener datos
          var tableRows = document.querySelectorAll('#tablaRegistros tbody tr');
          tableRows.forEach(function(row) {
              var rowData = [];
              row.querySelectorAll('td').forEach(function(cell) {
                  rowData.push(cell.textContent);
              });
              data.push(rowData);
          });

          // Crear CSV
          var csvContent = "data:text/csv;charset=utf-8,";
          data.forEach(function(rowArray) {
              var row = rowArray.join(",");
              csvContent += row + "\r\n";
          });

          // Descargar CSV
          var encodedUri = encodeURI(csvContent);
          var link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "registros_operario_<%= cedula %>.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      });
  });
</script>
<% } %> <%- include('partials/footer') %>
